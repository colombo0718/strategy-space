<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emoji Horse Runner (Animation MVP)</title>
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‡</text></svg>">
  <script src="https://unpkg.com/konva@8.4.0/konva.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #222;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #container { background: #fff; }
  </style>
</head>
<body>
<div id="container"></div>

<script>
  // ===== éŠæˆ²é‚è¼¯åº§æ¨™ï¼ˆå›ºå®šè§£æåº¦ï¼‰ =====
  const GAME_W = 1000;
  const GAME_H = 1000;

  const GROUND_Y = 700;        // åœ°é¢é«˜åº¦
    const GRAVITY_Z = 0.5;      // å¾€ä¸‹åŠ é€Ÿåº¦ï¼ˆæ•¸å€¼å¯å¾®èª¿ï¼‰
    const JUMP_VZ   = 7;        // èµ·è·³åˆé€Ÿåº¦ï¼ˆæ­£å€¼=å¾€ä¸Šï¼‰

  const EMOJI_FONT = 'Arial, "Apple Color Emoji", "Segoe UI Emoji", sans-serif';

  const container = document.getElementById('container');

  const stage = new Konva.Stage({
    container: 'container',
    width: GAME_W,
    height: GAME_H,
  });

  const gameLayer = new Konva.Layer();
  const uiLayer = new Konva.Layer();
  stage.add(gameLayer);
  stage.add(uiLayer);

// ===== èƒŒæ™¯åˆ†å±¤ï¼šå¤©ç©º / è‰åœ° / åœŸåœ° =====
// 0~300ï¼šå¤©ç©ºè—
const bgSky = new Konva.Rect({
  x: 0,
  y: 0,
  width: GAME_W,
  height: 300,
  fill: '#7EC8FF', // å¤©ç©ºè—ï¼ˆä½ è¦æ›´æ·¡/æ›´æ·±å†èª¿ï¼‰
});

// 300~800ï¼šç¶ åœ°ï¼ˆä¸»è§’/åœ°åœ–ç‰©ä»¶è·‘çš„å€åŸŸï¼‰
const bgGrass = new Konva.Rect({
  x: 0,
  y: 300,
  width: GAME_W,
  height: 500,     // 800 - 300
  fill: '#6ED36E', // è‰åœ°ç¶ 
});

// 800~1000ï¼šåœŸåœ°ï¼ˆå’–å•¡è‰²ï¼‰
const bgDirt = new Konva.Rect({
  x: 0,
  y: 800,
  width: GAME_W,
  height: 200,     // 1000 - 800
  fill: '#8B5A2B', // åœŸåœ°å’–å•¡
});

// âœ… èƒŒæ™¯è¦å…ˆ addï¼Œç¢ºä¿åœ¨æ‰€æœ‰ç‰©ä»¶ä¸‹é¢
gameLayer.add(bgSky);
gameLayer.add(bgGrass);
gameLayer.add(bgDirt);

  // ===== ç©å®¶ï¼ˆğŸ‡ï¼‰ + é™°å½±ï¼ˆğŸ•³ï¼‰ =====
  const PLAYER_FONT_SIZE = 44;
  let runPhase = 0;

const player = {
  // ä½ç½®ï¼ˆé‚è¼¯åº§æ¨™ï¼‰
  x: 850,
  y: GROUND_Y, // ä»£è¡¨ã€Œè³½é“é«˜åº¦ / è¸©åœ¨å“ªæ¢è·‘é“ã€
  z: 0,        // ä»£è¡¨ã€Œé›¢åœ°é«˜åº¦ã€ï¼ˆè·³èºç”¨ï¼‰

  // é€Ÿåº¦ï¼ˆé‚è¼¯é€Ÿåº¦ï¼‰
  vx: 5,      // ä¸–ç•Œç›¸å°é€Ÿåº¦ï¼šä½ ä¹‹å¾Œæœƒæ‹¿å®ƒå»æ¨ã€ŒèƒŒæ™¯/éšœç¤™ç‰©ã€å¾€å·¦ç§»
  vy: 0,       // è®Šæ›è·‘é“æ™‚æ‰ç”¨ï¼ˆä¾‹å¦‚ä¸Šä¸‹æ›è·‘é“çš„æ»‘å‹•é€Ÿåº¦ï¼‰ï¼›è·³èºä¸å†ç”¨å®ƒ
  vz: 0,       // è·³èºåˆé€Ÿåº¦æ”¾é€™è£¡ï¼ˆèµ·è·³ = çµ¦å®ƒä¸€å€‹æ­£å€¼ï¼‰

  onGround: true,

  fontSize: PLAYER_FONT_SIZE,
  group: null,
  sprite: null,
};

  // ä»¥è…³åº•ç‚ºåŸé»çš„ group
  player.group = new Konva.Group({
    x: player.x,
    y: player.y,
  });
  gameLayer.add(player.group);

  // çœŸæ­£çš„ emoji ç•«åœ¨ group è£¡ 
  player.sprite = new Konva.Text({
    x: -player.fontSize / 2,
    y: -player.fontSize,
    text: 'ğŸ‡',
    fontSize: player.fontSize,
    fontFamily: EMOJI_FONT,
  });
  player.group.add(player.sprite);

  // é™°å½± ğŸ•³ï¼ˆå›ºå®šè²¼åœ°ã€è·Ÿéš¨ç©å®¶ Xï¼ŒY å›ºå®šåœ°é¢ï¼‰
  const shadow = new Konva.Text({
    x: player.x -player.fontSize / 2,
    y: player.y,
    text: 'âš«',
    fontSize: 28,
    fontFamily: EMOJI_FONT,
    opacity: 0.85,
    scaleX: 1.5,               //  
    scaleY: 0.5,               // 
  });
  gameLayer.add(shadow);

  function updatePlayerNodes() {
    // åœ°é¢è·‘æ­¥ï¼šåšã€Œæ©«è‘—çš„ 8ã€è»Œè·¡ï¼ˆLissajous 1:2ï¼‰
    // - ä¸Šä¸‹ï¼šè¼ƒå¤§å¹…åº¦ï¼Œè¼ƒçŸ­å‘¨æœŸï¼ˆsin(t)ï¼‰
    // - å‰å¾Œï¼šè¼ƒå°å¹…åº¦ï¼Œå‘¨æœŸå…©å€é•·ï¼ˆsin(t/2)ï¼‰
    // é€™çµ„åˆçœ‹èµ·ä¾†æœƒåƒæ©«è‘—çš„âˆï¼ˆfigure-eight-ishï¼‰
    const yBounceAmp = 4; // ä¸Šä¸‹å¹…åº¦
    const xSwayAmp   = 2; // å‰å¾Œ(å·¦å³)å¹…åº¦ï¼ˆæ¯”ä¸Šä¸‹å°ï¼‰

    const yBounce = player.onGround ? Math.sin(runPhase) * yBounceAmp : 0;
    const xSway   = player.onGround ? Math.sin(runPhase / 2) * xSwayAmp : 0;

    // ğŸ‡ å¾®å¾®ã€Œå‰å¾Œæ™ƒã€ï¼šè®“é¦¬çš„ group åœ¨ x ä¸Šåç§»
    // ğŸ•³ é™°å½±å›ºå®šåœ¨åœ°ä¸Šï¼Œä¸è·Ÿè‘— xSwayï¼Œé€™æ¨£ä½ æœƒæ›´æ¸…æ¥šçœ‹åˆ°ã€Œé¦¬ vs é™°å½±ã€è·é›¢è®ŠåŒ–
    player.group.position({
      x: player.x + xSway,
      y: (player.y - player.z) + yBounce,  // âœ… z è¶Šå¤§ï¼Œé¦¬è¶Šå¾€ä¸Š
    });

    shadow.position({
      x: player.x - player.fontSize / 2+ xSway + player.z/2,
      y: player.y - player.fontSize / 6,
    });
  }
  // ===== è·³èºé‚è¼¯ =====
    function doJump() {
    if (player.onGround) {
        player.vz = JUMP_VZ;    // âœ… èµ·è·³åˆé€Ÿåº¦æ”¾åœ¨ z æ–¹å‘
        player.onGround = false;
    }
    }

// ===== éµç›¤æ§åˆ¶ï¼šSpace è·³ï¼›W/S æˆ– â†‘/â†“ è®“ player.y å¹³æ»‘ç§»å‹• =====
let moveUp = false;
let moveDown = false;

window.addEventListener('keydown', (e) => {
  if (e.code === 'Space') {
    doJump();
    e.preventDefault();
    return;
  }

  if (e.code === 'KeyW' || e.code === 'ArrowUp') {
    moveUp = true;
    e.preventDefault();
    return;
  }

  if (e.code === 'KeyS' || e.code === 'ArrowDown') {
    moveDown = true;
    e.preventDefault();
    return;
  }
});

window.addEventListener('keyup', (e) => {
  if (e.code === 'KeyW' || e.code === 'ArrowUp') {
    moveUp = false;
    e.preventDefault();
    return;
  }

  if (e.code === 'KeyS' || e.code === 'ArrowDown') {
    moveDown = false;
    e.preventDefault();
    return;
  }
});

// ===== y è»¸å¹³æ»‘ç§»å‹•ï¼ˆæŒ‰ä½å›ºå®šé€Ÿåº¦ï¼‰ï¼Œç¯„åœ 500~700 =====
const RUN_MIN_Y = 550;
const RUN_MAX_Y = 750;

const Y_SPEED = 5; // æŒ‰ä½æ™‚çš„ y æ–¹å‘é€Ÿåº¦ï¼ˆä½ å¯èª¿ï¼š4~10ï¼‰


// ===== ç‰©ä»¶ç”Ÿæˆï¼ˆåªè¦æœƒå‹•å°±å¥½ï¼‰ =====
const movers = []; // { node, kind }

function rand(min, max) {
  return Math.random() * (max - min) + min;
}
function choice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function spawnRunnerItem() {
  const emoji = choice(['ğŸš§', 'ğŸ']); // è‰åœ°è·‘é“å…§å‡ºç¾
  const node = new Konva.Text({
    x: -60, // å¾å·¦é‚Šå¤–é¢å‡ºç”Ÿ
    y: rand(RUN_MIN_Y, RUN_MAX_Y),
    text: emoji,
    fontSize: 44,
    fontFamily: EMOJI_FONT,
  });
  gameLayer.add(node);
  movers.push({ node, kind: 'runner' });
}

function spawnTarget() {
  const node = new Konva.Text({
    x: -60,
    y: rand(350, 450), // é¶å­å€
    text: 'ğŸ¯',
    fontSize: 44,
    fontFamily: EMOJI_FONT,
  });
  gameLayer.add(node);
  movers.push({ node, kind: 'target' });
}

// ç”Ÿæˆç¯€å¥ï¼šç”¨ã€Œå€’æ•¸ã€åšéš¨æ©Ÿé–“éš”ï¼ˆç°¡å–®ç©©ï¼‰
let spawnRunnerIn = 0;
let spawnTargetIn = 0;

function resetRunnerTimer() {
  spawnRunnerIn = Math.floor(rand(18, 45)); // è¶Šå°è¶Šå¯†ï¼ˆå¹€æ•¸ï¼‰
}
function resetTargetTimer() {
  spawnTargetIn = Math.floor(rand(40, 90));
}
resetRunnerTimer();
resetTargetTimer();

  // ===== ä¸»è¿´åœˆï¼šåªæœ‰ç‰©ç† + å‹•ç•«ï¼ˆä¸å«éšœç¤™ç‰©ã€åˆ†æ•¸ã€ç¢°æ’ï¼‰ =====
  function update() {
    // ç‰©ç†ï¼šè·³èºï¼ˆz è»¸ï¼‰
    player.z += player.vz;
    player.vz -= GRAVITY_Z;    // âœ… å¾€ä¸‹æ‹‰ï¼ˆz é€Ÿåº¦éæ¸›ï¼‰

    if (player.z <= 0) {       // âœ… è½åœ°ï¼šz å›åˆ° 0
    player.z = 0;
    player.vz = 0;
    player.onGround = true;
    } else {
    player.onGround = false;
    }

// ä¾æŒ‰éµç›´æ¥çµ¦é€Ÿåº¦ï¼ˆæ”¾é–‹å°±æœƒå›åˆ° 0ï¼‰
if (moveUp && !moveDown) player.vy = -Y_SPEED;
else if (moveDown && !moveUp) player.vy =  Y_SPEED;
else player.vy = 0;

// æ›´æ–° y
player.y += player.vy;

// ç¯„åœé™åˆ¶
if (player.y < RUN_MIN_Y) player.y = RUN_MIN_Y;
if (player.y > RUN_MAX_Y) player.y = RUN_MAX_Y;

// ===== ç‰©ä»¶éš¨æ©Ÿç”Ÿæˆ =====
spawnRunnerIn--;
spawnTargetIn--;

if (spawnRunnerIn <= 0) {
  spawnRunnerItem();
  resetRunnerTimer();
}
if (spawnTargetIn <= 0) {
  spawnTarget();
  resetTargetTimer();
}

// ===== ç‰©ä»¶ç§»å‹•ï¼ˆä¾ player.vx å¾€å³ï¼‰+ è¶…å‡ºå°±ç§»é™¤ =====
const killX = GAME_W + 80;
for (let i = movers.length - 1; i >= 0; i--) {
  const m = movers[i];
  m.node.x(m.node.x() + player.vx);

  if (m.node.x() > killX) {
    m.node.destroy();
    movers.splice(i, 1);
  }
}


    // åœ¨åœ°é¢æ™‚è·‘æ­¥å‹•ç•«ï¼ˆé¡›ç°¸é »ç‡ï¼‰
    if (player.onGround) {
      runPhase += 0.4;
    } else {
      // ç©ºä¸­å°±ä¸é¡›
      runPhase = 0;
    }

    updatePlayerNodes();
  }

  function loop() {
    update();
    gameLayer.batchDraw();
    uiLayer.batchDraw();
    requestAnimationFrame(loop);
  }

  // ===== éŸ¿æ‡‰å¼ç¸®æ”¾ï¼šç¶­æŒ 16:9ï¼Œç­‰æ¯”ä¾‹æ”¾å¤§ä¸¦ç½®ä¸­ =====
  function fitStageIntoWindow() {
    const w = window.innerWidth;
    const h = window.innerHeight;

    const scale = Math.min(w / GAME_W, h / GAME_H);
    const newWidth  = GAME_W * scale;
    const newHeight = GAME_H * scale;

    stage.width(newWidth);
    stage.height(newHeight);
    stage.scale({ x: scale, y: scale });

    container.style.width  = newWidth + 'px';
    container.style.height = newHeight + 'px';

    stage.draw();
  }

  window.addEventListener('resize', fitStageIntoWindow);

  // å•Ÿå‹•
  updatePlayerNodes();
  fitStageIntoWindow();
  loop();
</script>
</body>
</html>
